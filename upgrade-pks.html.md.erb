---
title: Upgrading Enterprise PKS
owner: PKS
topictype: vsphereupgrade
---

This topic explains how to upgrade the <%= vars.product_full %> tile and existing Kubernetes clusters.

For information about upgrading <%= vars.product_short %> on vSphere with NSX-T integration, see
[Upgrading <%= vars.product_short %> with NSX-T](upgrade-pks-nsxt.html).

## <a id="overview"></a>Overview

<%= vars.product_short %> versions 1.4.2 and later support directly upgrading from <%= vars.product_short %> v1.3.4 or later. 
For more information about your upgrade path, see [Determine Your Upgrade Path](#upgrade-path) below.  

To plan and prepare before beginning your <%= vars.product_short %> upgrade, follow the procedures in [Prerequisites](#before), below.

After completing the prerequisite steps, continue to the procedures in [During the Upgrade](#upgrade), below. These steps guide you through upgrading the <%= vars.product_tile %> tile, upgrading Ops Manager, importing an updated stemcell, and applying the changes to your deployment.

After completing the upgrade, verify that your upgraded <%= vars.product_short %> deployment is running properly 
by following the procedures in [After the Upgrade](#after-upgrade), below.

<p class="note warning"><strong>Warning</strong>: Do not manually upgrade your Kubernetes version. The <%= vars.product_short %> service includes the compatible Kubernetes version.</p>

## <a id="before"></a>Prerequisites

Before you upgrade <%= vars.product_short %>, you must do the following:

1. [Determine Your Upgrade Path](#upgrade-path)
1. [Prepare to Upgrade](#prepare)

On Azure, <%= vars.product_short %> v1.4.0 is compatible only with Ops Manager v2.4.2, v2.4.3, v2.4.13, and v2.5.5 and later. 
For all other IaaSes, <%= vars.product_short %> v1.4.0 is compatible with Ops Manager v2.4.2+ and v2.5.x. 

## <a id="upgrade-path"></a> Determine Your Upgrade Path

Use the following table to determine your upgrade path to <%= vars.product_short %> v1.4.

<table>
<tr>
  <th>If your current version of PKS is...</th>
  <th>Then use the following upgrade path:</th>
</tr>
<tr>
  <td>v1.2.7 or earlier, or v1.3.0</td>
  <td>
    <ol>
      <li>Upgrade to Ops Manager v2.4.2 or later in the 2.4 version line. If upgrading on Azure, upgrade to Ops Manager v2.4.2, v2.4.3, or v2.4.13.</li>
      <li>To upgrade to PKS v1.3.2, follow the procedures in <a href='https://community.pivotal.io/s/article/pks-upgrade-approach-for-critical-cve'>
      PKS upgrade approach for CRITICAL CVE: 2019-3779 (67116)</a> in the Pivotal Knowledge Base.</li>
      <li>Upgrade to <%= vars.product_short %> v1.4.1.</li>
      <li>(Optional) Upgrade to <%= vars.product_short %> v1.4.2 or later.</li>
      <li>(Optional) Upgrade to Ops Manager v2.5.x. If upgrading on Azure, upgrade to Ops Manager v2.5.5 or later in the 2.5 version line.</li>
    </ol>
  </td>
</tr>
<tr>
  <td>v1.2.8 or later, or v1.3.1</td>
  <td>
    <ol>
      <li>Upgrade to Ops Manager v2.4.2 or later in the 2.4 version line. If upgrading on Azure, upgrade to Ops Manager v2.4.2, v2.4.3, or v2.4.13.</li>
      <li>Review the upgrade procedures in <a href='https://community.pivotal.io/s/article/pks-upgrade-approach-for-critical-cve'>
      PKS upgrade approach for CRITICAL CVE: 2019-3779 (67116)</a> in the Pivotal Knowledge Base.</li>
      <li>Upgrade to <%= vars.product_short %> v1.3.4.</li>
      <li>Upgrade to <%= vars.product_short %> v1.4.2 or later.</li>
      <li>(Optional) Upgrade to Ops Manager v2.5.x. If upgrading on Azure, upgrade to Ops Manager v2.5.5 or later in the 2.5 version line.</li>
    </ol>
  </td>
</tr>
<tr>
  <td>v1.3.2 or v1.3.3</td>
  <td>
    <ol>
      <li>Upgrade to Ops Manager v2.4.2 or later in the 2.4 version line. If upgrading on Azure, upgrade to Ops Manager v2.4.2, v2.4.3, or v2.4.13.</li>
      <li>Upgrade to <%= vars.product_short %> v1.4.1.</li>
      <li>(Optional) Upgrade to <%= vars.product_short %> v1.4.2 or later.</li>
      <li>(Optional) Upgrade to Ops Manager v2.5.x. If upgrading on Azure, upgrade to Ops Manager v2.5.5 or later in the 2.5 version line.</li>
    </ol>
  </td>
</tr>
<tr>
  <td>v1.3.4 or later, or 1.4.0 or later</td>
  <td>
    <ol>
      <li>Upgrade to Ops Manager v2.4.2 or later in the 2.4 version line. If upgrading on Azure, upgrade to Ops Manager v2.4.2, v2.4.3, or v2.4.13.</li>
      <li>Upgrade to <%= vars.product_short %> v1.4.2 or later.</li>
      <li>(Optional) Upgrade to Ops Manager v2.5.x. If upgrading on Azure, upgrade to Ops Manager v2.5.5 or later in the 2.5 version line.</li>
    </ol>
  </td>
</tr>
</table>

## <a id="prepare"></a>Prepare to Upgrade

Complete all of the steps in the [Upgrade Preparation Checklist for PKS v1.4](./checklist.html).

## <a id="upgrade"></a> During the Upgrade

To upgrade to <%= vars.product_short %> v1.4.x, complete the following steps:

1. [Upgrade to <%= vars.product_short %> v1.2.7 or Later](#upgrade-pks)
1. [Upgrade to Ops Manager v2.4.2 or Later](#upgrade-opsman)
1. [Upgrade to <%= vars.product_short %> v1.3.2](#upgrade-tile-1-3)
1. [Upgrade to <%= vars.product_short %> v1.3.4](#upgrade-tile-1-3-4)
1. [Upgrade to <%= vars.product_short %> v1.4.x](#upgrade-tile-1-4)

### <a id="upgrade-pks"></a>Upgrade to <%= vars.product_short %> v1.2.7 or Later

Skip this step if you are already running <%= vars.product_short %> v1.2.7 or later.

To upgrade to <%= vars.product_short %> v1.2.7 or later, follow the procedures detailed in [Upgrading PKS](https://docs.pivotal.io/pks/1-2/upgrade-pks.html) in the PKS v1.2 documentation.

### <a id="upgrade-opsman"></a>Upgrade to Ops Manager v2.4.2 or Later

Skip this step if you are already running Ops Manager v2.4.2 or later.

Before you upgrade to <%= vars.product_short %> v1.3.x and <%= vars.product_short %> v1.4.x, you must upgrade to Ops Manager v2.4.2 or later.

1. Follow the procedures detailed in [Upgrade Ops Manager and Installed Products to v2.4](https://docs.pivotal.io/pivotalcf/2-4/customizing/upgrading-pcf.html#upgrade_ops).

1. <%= partial 'add-clusters-workloads' %>

### <a id="upgrade-tile-1-3"></a>Upgrade to <%= vars.product_short %> v1.3.2

Skip this step if you are already running <%= vars.product_short %> v1.3.2 or v1.3.4 or later.

To upgrade to <%= vars.product_short %> v1.4.1, you must upgrade from PKS v1.3.2.

Follow the procedures detailed in [Upgrading <%= vars.product_short %>](https://docs.pivotal.io/pks/1-3/upgrade-pks.html) in the PKS v1.3 documentation.

For more information about this upgrade, see [PKS upgrade approach for CRITICAL CVE: 2019-3779 (67116)](https://community.pivotal.io/s/article/pks-upgrade-approach-for-critical-cve).

### <a id="upgrade-tile-1-3-4"></a>Upgrade to <%= vars.product_short %> v1.3.4

Skip this step if you are already running <%= vars.product_short %>  v1.3.2 or v1.3.4 or later.

Follow the procedures detailed in [Upgrading <%= vars.product_short %>](https://docs.pivotal.io/pks/1-3/upgrade-pks.html) in the PKS v1.3 documentation.

For more information about this upgrade, see [PKS upgrade approach for CRITICAL CVE: 2019-3779 (67116)](https://community.pivotal.io/s/article/pks-upgrade-approach-for-critical-cve).

### <a id="upgrade-tile-1-4"></a>Upgrade to <%= vars.product_short %> v1.4.x

To upgrade to <%= vars.product_short %> v1.4.x, complete the follow steps:  

1. Review the [Release Notes](release-notes.html) for the version you are upgrading to.

1. Download the desired version of the product from [Pivotal Network](https://network.pivotal.io/products/pivotal-container-service/).

    <p class="note"><strong>Note:</strong> 
    To upgrade to <%= vars.product_short %> v1.4.2, you must upgrade from <%= vars.product_short %> 
    v1.3.4 or later, or v1.4.0 or later.
    </p>

    <p class="note warning"><strong>Warning:</strong> Before upgrading from <%= vars.product_short %> v1.3.x to v1.4.x, you must increase the size of persistent disk for the PKS VM.
    For more information, see <a href="release-notes.html#not-enough-diskspace">Upgrade Fails Due to Insufficient Disk Space</a> in the Known Issues.</p>

1. Navigate to the Ops Manager Installation Dashboard and click **Import a Product** to upload the product file.

1. Under the **Import a Product** button, click **+** next to **<%= vars.product_tile %>**. This adds the tile to your staging area.
    <p class="note"><strong>Note:</strong> Your configuration settings migrate to the new version automatically.</p>
1. Complete the steps in [Download and Import the Stemcell](#stemcell), below.  

1. Complete the steps in [Verify Errand Configuration](#worker-nodes), below.  

1. Complete the steps in [Apply Changes to the <%= vars.product_tile %> Tile](#apply-changes), below.

#### <a id="stemcell"></a>Download and Import the Stemcell

<%= vars.product_short %> v1.4.x uses a [Xenial stemcell](https://docs.pivotal.io/pivotalcf/2-5/stemcells/#xenial).

If Ops Manager does not have the Xenial stemcell required for <%= vars.product_short %>, the <%= vars.product_tile %> tile displays the message **Missing stemcell**.

<p class="note"><strong>Note:</strong> If the <b>Stemcell Library</b> in Ops Manager already has a compatible Xenial stemcell,
  the <b>Missing stemcell</b> link does not appear. You do not need to download or import a new stemcell and can skip this step.</p>

To download and import a new Xenial stemcell, follow the steps below:

1. On the <%= vars.product_tile %> tile, click on the **Missing stemcell** link.

    <img src="images/missing_stemcell.png" alt="Verify stemcell assignment">

1. In the **Stemcell Library**, locate **<%= vars.product_tile %>** tile and note the required stemcell version.

1. Visit the [Stemcells for PCF (Ubuntu Xenial)](https://network.pivotal.io/products/stemcells-ubuntu-xenial/) page on Pivotal Network,
and download the required stemcell version appropriate for your IaaS.

1. Return to the **Installation Dashboard** in Ops Manager, and click on **Stemcell Library**.

1. On the **Stemcell Library** page, click **Import Stemcell** and select the stemcell file you downloaded from Pivotal Network.

1. Select <%= vars.product_tile %> tile and click **Apply Stemcell to Products**.

1. Verify that Ops Manager successfully applied the stemcell. The stemcell version you imported and applied appears in the **Staged** column for <%= vars.product_tile %>.

1. Select the **Installation Dashboard** link to return to the Installation Dashboard.

#### <a id="worker-nodes"></a>Verify Errand Configuration

To verify that errands are configured correctly in the <%= vars.product_tile %> tile, perform the following steps.

1. Click the newly-added **<%= vars.product_tile %>** tile.

1. Click **Errands**.

1. Under **Post-Deploy Errands**, verify that the **Upgrade all clusters errand** is set to **Default (On)**. The errand upgrades a single Kubernetes cluster at a time. Upgrading PKS-deployed Kubernetes clusters can temporarily interrupt the service, as described in [Service Interruptions](interruptions.html).

    <p class="note warning"><strong>Warning</strong>: If you are upgrading <%= vars.product_short %>, you must enable the <strong>Upgrade All Clusters</strong> errand.</p>

1. Under **Post-Deploy Errands**, set the **Run smoke tests** errand to **On**. The errand uses the PKS Command Line Interface (PKS CLI) to create a Kubernetes cluster and then delete it. If the creation or deletion fails, the errand fails and the installation of the <%= vars.product_tile %> tile is aborted.

1. Review the other configuration panes. Click **Save** on any panes where you make changes.
    <p class="note warning"><strong>WARNING</strong>: Do not change the number of master/etcd nodes 
    for any plan that was used to create currently-running clusters. 
    <%= vars.product_short %> does not support changing the number of master/etcd nodes for plans 
    with existing clusters.
    </p>
    <p class="note"><strong>Note</strong>: When you upgrade <%= vars.product_short %>, you must place singleton jobs in the AZ you selected when you first installed the <%= vars.product_tile %> tile. You cannot move singleton jobs to another AZ.</p>

#### <a id="apply-changes"></a>Apply Changes to the <%= vars.product_tile %> Tile

Perform the following steps to complete the upgrade to the <%= vars.product_tile %> tile.

1. Return to the **Installation Dashboard** in Ops Manager.

1. Click **Review Pending Changes**.
     For more information about this Ops Manager page, see
    [Reviewing Pending Product Changes](https://docs.pivotal.io/pivotalcf/2-3/customizing/review-pending-changes.html).

1. Click **Apply Changes**.

1. (Optional) To monitor the progress of the **Upgrade all clusters errand** using the BOSH CLI, do the following:
      1. Log in to the BOSH Director by running `bosh -e MY-ENVIRONMENT log-in` from a VM that can access your <%= vars.product_short %> deployment. For more information, see [Managing <%= vars.product_short %> Deployments with BOSH](manage-deployments-bosh.html).
      1. Run `bosh -e MY-ENVIRONMENT tasks`.
      1. Locate the task number for the errand in the <strong>&#35;</strong> column of the BOSH output.
      1. Run `bosh task TASK-NUMBER`, replacing `TASK-NUMBER` with the task number you located in the previous step.

## <a id="after-upgrade"></a>After the Upgrade

After you complete the upgrade to <%= vars.product_short %> v1.4.x, complete the following verifications and upgrades:

- [Update PKS and Kubernetes CLIs](#update-clis)
- [Verify the Upgrade](#verify-upgrade)
- [Upgrade vSphere](#upgrade-vcenter)

### <a id="update-clis"></a>Update PKS and Kubernetes CLIs

Update the PKS and Kubernetes CLIs on any local machine
where you run commands that interact with your upgraded version of <%= vars.product_short %>.

To update your CLIs, download and re-install the PKS and Kubernetes CLI distributions
that are provided with <%= vars.product_short %> on Pivotal Network.

For more information about installing the CLIs, see the following topics:

* [Installing the PKS CLI](installing-pks-cli.html)

* [Installing the Kubernetes CLI](installing-kubectl-cli.html)

### <a id="verify-upgrade"></a>Verify the Upgrade

After you apply changes to the <%= vars.product_tile %> tile and the upgrade is complete, perform the following steps:

1. Verify that your Kubernetes environment is healthy. To verify the health of your Kubernetes environment, see [Verifying
Deployment Health](verify-health.html#k8s).

1. <%= partial 'add-clusters-workloads' %>

### <a id="upgrade-opsman"></a> (Optional) Upgrade to Ops Manager v2.5.x

<%= vars.product_short %> v1.4.x is compatible with Ops Manager v2.5.x on all IaaS except Azure. On Azure, <%= vars.product_short %> v1.4.x is compatible only with Ops Manager v2.5.5 or later.

To upgrade Ops Manager, perform the following steps:

1. Follow the procedures detailed in [Upgrade Ops Manager and Installed Products to v2.5](https://docs.pivotal.io/pivotalcf/2-5/customizing/upgrading-pcf.html#upgrade_ops).

1. <%= partial 'add-clusters-workloads' %>

### <a id="upgrade-vcenter"></a>Upgrade vSphere

If you are deploying <%= vars.product_short %> on vSphere, consult the chart below, and upgrade vSphere if necessary.
<%= partial 'vsphere_versions' %>
